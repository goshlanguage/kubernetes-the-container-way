version: '3'
services:
  etcd:
    image: quay.io/coreos/etcd:v3.3
    entrypoint: /scripts/etcd_entry.sh
    environment:
      - ETCDCTL_API=3
    hostname: etcd
    volumes:
      - ./bin:/scripts/
      - ./certs:/certs
      - /tmp/etcd:/var/lib/etcd

  # latest Hyperkube tags can be found here:
  # https://console.cloud.google.com/gcr/images/google-containers/GLOBAL/hyperkube?authuser=2&gcrImageListsize=50
  kube-apiserver:
    image: gcr.io/google-containers/hyperkube:v1.12.2
    command: kube-apiserver --etcd-servers "http://etcd:2379" --insecure-bind-address 0.0.0.0
    depends_on:
      - etcd
    ports:
      - 8080:8080

  kube-controller-manager:
    image: gcr.io/google-containers/hyperkube:v1.12.2
    command: |
      kube-controller-manager \
        --address=0.0.0.0 \
        --cluster-name=kubernetes \
        --kubeconfig=/conf/kube-controller-manager.yaml \
        --leader-elect=true \
        --v=2
    depends_on:
      - etcd
    volumes:
      - ./conf:/conf

